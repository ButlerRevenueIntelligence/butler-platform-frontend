<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Butler & Co Revenue Intelligence Platform</title>

  <!-- React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- PropTypes (Recharts needs this in UMD builds) -->
  <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>

  <!-- Recharts UMD -->
  <script src="https://cdn.jsdelivr.net/npm/recharts@2.5.0/umd/Recharts.min.js"></script>

  <!-- Babel (so we can run JSX in a single HTML file) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #0A0E1A 0%, #1A1F2E 100%);
      color: #fff;
      min-height: 100vh;
    }
    .loading {
      display: flex; align-items: center; justify-content: center;
      min-height: 100vh; flex-direction: column; gap: 20px;
    }
    .spinner {
      width: 60px; height: 60px;
      border: 4px solid rgba(0, 71, 255, 0.1);
      border-top: 4px solid #0047FF;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }

    button { cursor: pointer; font-family: inherit; }
    input { font-family: inherit; }

    .errorBox {
      background: rgba(255, 51, 102, 0.10);
      border: 1px solid #FF3366;
      padding: 16px;
      border-radius: 10px;
      margin: 20px;
      white-space: pre-wrap;
      line-height: 1.4;
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const {
      AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip,
      ResponsiveContainer, PieChart, Pie, Cell
    } = Recharts;

    // ========= CONFIG =========
    const API_URL = 'https://butler-platform-backend.onrender.com/api/v1';

    // ========= API HELPER =========
    const api = {
      async login(email, password) {
        const response = await fetch(`${API_URL}/auth/token`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        if (!response.ok) throw new Error('Login failed');
        return response.json();
      },
      async get(endpoint, token) {
        const response = await fetch(`${API_URL}${endpoint}`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        if (!response.ok) throw new Error(`API request failed: ${endpoint}`);
        return response.json();
      }
    };

    // ========= ERROR BOUNDARY (prevents blank screen) =========
    class ErrorBoundary extends React.Component {
      constructor(props) {
        super(props);
        this.state = { hasError: false, message: '' };
      }
      static getDerivedStateFromError(error) {
        return { hasError: true, message: String(error?.stack || error) };
      }
      componentDidCatch(error) {
        console.error('Render crash:', error);
      }
      render() {
        if (this.state.hasError) {
          return (
            <div style={{ padding: '24px' }}>
              <h2 style={{ marginBottom: '12px' }}>Something crashed (but itâ€™s fixable).</h2>
              <div className="errorBox">{this.state.message}</div>
              <div style={{ color: '#8B92A8', fontSize: '14px' }}>
                Tip: open DevTools â†’ Console to see the same error.
              </div>
            </div>
          );
        }
        return this.props.children;
      }
    }

    // ========= LOGIN =========
    function LoginPage({ onLogin }) {
      const [email, setEmail] = useState('demo@butlerco.com');
      const [password, setPassword] = useState('demo123');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');
        try {
          const data = await api.login(email, password);
          onLogin(data.access_token, data.user || { email });
        } catch (err) {
          setError('Invalid credentials. Try demo@butlerco.com / demo123');
        } finally {
          setLoading(false);
        }
      };

      return (
        <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '20px' }}>
          <div style={{ maxWidth: '420px', width: '100%', background: 'rgba(255,255,255,0.03)', padding: '40px', borderRadius: '16px', border: '1px solid rgba(255,255,255,0.1)' }}>
            <div style={{ textAlign: 'center', marginBottom: '26px' }}>
              <div style={{ width: '60px', height: '60px', background: 'linear-gradient(135deg, #0047FF, #00D9FF)', borderRadius: '12px', margin: '0 auto 16px', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '28px' }}>ðŸ“Š</div>
              <h1 style={{ fontSize: '24px', marginBottom: '8px' }}>Butler & Co</h1>
              <p style={{ color: '#8B92A8', fontSize: '14px' }}>Revenue Intelligence Platform</p>
            </div>

            {error && (
              <div className="errorBox" style={{ margin: '0 0 16px 0' }}>{error}</div>
            )}

            <form onSubmit={handleSubmit}>
              <div style={{ marginBottom: '16px' }}>
                <label style={{ display: 'block', marginBottom: '8px', fontSize: '14px', color: '#8B92A8' }}>Email</label>
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  style={{ width: '100%', padding: '12px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '8px', color: '#fff', fontSize: '14px' }}
                  required
                />
              </div>

              <div style={{ marginBottom: '22px' }}>
                <label style={{ display: 'block', marginBottom: '8px', fontSize: '14px', color: '#8B92A8' }}>Password</label>
                <input
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  style={{ width: '100%', padding: '12px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '8px', color: '#fff', fontSize: '14px' }}
                  required
                />
              </div>

              <button
                type="submit"
                disabled={loading}
                style={{ width: '100%', padding: '14px', background: 'linear-gradient(135deg, #0047FF, #00D9FF)', border: 'none', borderRadius: '8px', color: '#fff', fontSize: '16px', fontWeight: 600, opacity: loading ? 0.7 : 1 }}
              >
                {loading ? 'Signing in...' : 'Sign In'}
              </button>
            </form>

            <div style={{ marginTop: '18px', padding: '14px', background: 'rgba(0,217,255,0.05)', border: '1px solid rgba(0,217,255,0.2)', borderRadius: '8px', fontSize: '12px', color: '#8B92A8' }}>
              <strong style={{ color: '#00D9FF' }}>Demo Account:</strong><br />
              Email: demo@butlerco.com<br />
              Password: demo123
            </div>
          </div>
        </div>
      );
    }

    // ========= DASHBOARD =========
    function Dashboard({ token, user, onLogout }) {
      const [activeView, setActiveView] = useState('overview');
      const [loading, setLoading] = useState(true);
      const [revenueData, setRevenueData] = useState(null);
      const [insights, setInsights] = useState([]);
      const [clients, setClients] = useState([]);

      const demoRevenue = {
        total_revenue: 295422,
        mrr: 25109,
        arr: 301304,
        previous_period_revenue: 220000,
        growth_rate: 0.34,
        by_period: [
          { period_start: "Jan", revenue: 180000 },
          { period_start: "Feb", revenue: 205000 },
          { period_start: "Mar", revenue: 220000 },
          { period_start: "Apr", revenue: 245000 },
          { period_start: "May", revenue: 270000 },
          { period_start: "Jun", revenue: 295422 }
        ],
        by_source: [
          { source: "SEO", revenue: 120000, percentage: 41 },
          { source: "Paid Ads", revenue: 95000, percentage: 32 },
          { source: "Referrals", revenue: 55000, percentage: 19 },
          { source: "Partners", revenue: 25422, percentage: 8 }
        ]
      };

      const demoInsights = [
        { id: 1, type: "opportunity", impact: "HIGH", confidence: 92, title: "Pipeline velocity increasing", description: "Your lead-to-close time is trending down. Consider scaling top-performing channels." },
        { id: 2, type: "warning", impact: "MED", confidence: 84, title: "One client showing churn signals", description: "Engagement is down in the last 14 days. Recommend a quick check-in + value report." }
      ];

      const demoClients = [
        { id: 1, company_name: "TechCorp Industries", industry: "IT Services", status: "active", mrr: 12500, health_score: 92 },
        { id: 2, company_name: "Sunrise Manufacturing", industry: "Manufacturing", status: "active", mrr: 8600, health_score: 88 }
      ];

      useEffect(() => { loadData(); }, []);

      const loadData = async () => {
        try {
          const [revenue, insightsData, clientsData] = await Promise.all([
            api.get('/revenue/summary', token),
            api.get('/insights/latest?limit=5', token),
            api.get('/clients', token)
          ]);

          const rev = (revenue && revenue.data && Object.keys(revenue.data).length > 0) ? revenue.data : demoRevenue;
          setRevenueData(rev);

          const ins = (insightsData && insightsData.data && Array.isArray(insightsData.data.insights)) ? insightsData.data.insights : demoInsights;
          setInsights(ins);

          const cls = (clientsData && clientsData.data && Array.isArray(clientsData.data)) ? clientsData.data : demoClients;
          setClients(cls);
        } catch (e) {
          console.error('API failed, using demo data:', e);
          setRevenueData(demoRevenue);
          setInsights(demoInsights);
          setClients(demoClients);
        } finally {
          setLoading(false);
        }
      };

      if (loading) {
        return (
          <div className="loading">
            <div className="spinner"></div>
            <div>Loading platform data...</div>
          </div>
        );
      }

      return (
        <div style={{ padding: '24px', minHeight: '100vh' }}>
          <div style={{ marginBottom: '32px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
            <div>
              <h1 style={{ fontSize: '32px', marginBottom: '8px' }}>Revenue Intelligence Platform</h1>
              <p style={{ color: '#8B92A8' }}>Welcome back, {user?.firstName || user?.email || 'Demo'}</p>
            </div>
            <button
              onClick={onLogout}
              style={{ padding: '10px 20px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '8px', color: '#fff', fontSize: '14px' }}
            >
              Sign Out
            </button>
          </div>

          <div style={{ borderBottom: '1px solid rgba(255,255,255,0.1)', marginBottom: '32px' }}>
            {['overview', 'insights', 'clients'].map(view => (
              <button
                key={view}
                onClick={() => setActiveView(view)}
                style={{
                  padding: '12px 24px',
                  background: 'transparent',
                  border: 'none',
                  borderBottom: activeView === view ? '2px solid #0047FF' : '2px solid transparent',
                  color: activeView === view ? '#0047FF' : '#8B92A8',
                  fontSize: '14px',
                  fontWeight: 600,
                  textTransform: 'capitalize'
                }}
              >
                {view}
              </button>
            ))}
          </div>

          {activeView === 'overview' && <OverviewView data={revenueData} />}
          {activeView === 'insights' && <InsightsView insights={insights} />}
          {activeView === 'clients' && <ClientsView clients={clients} />}
        </div>
      );
    }

    function Card({ title, value, subtitle, accent }) {
      return (
        <div style={{ background: 'rgba(255,255,255,0.03)', border: '1px solid rgba(255,255,255,0.08)', borderRadius: '12px', padding: '24px' }}>
          <div style={{ color: '#8B92A8', fontSize: '14px', marginBottom: '8px' }}>{title}</div>
          <div style={{ fontSize: '36px', fontWeight: 700, marginBottom: '8px' }}>{value}</div>
          <div style={{ color: accent || '#00FF88', fontSize: '14px' }}>{subtitle}</div>
        </div>
      );
    }

    function OverviewView({ data }) {
      if (!data) return <div>No data available</div>;

      const total = Number(data.total_revenue || 0);
      const mrr = Number(data.mrr || 0);
      const arr = Number(data.arr || 0);

      const growth = Number.isFinite(data.growth_rate) ? data.growth_rate : 0.34;

      const COLORS = ['#0047FF', '#00D9FF', '#00FF88', '#FFB800'];

      return (
        <div>
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '20px', marginBottom: '32px' }}>
            <Card title="Total Revenue" value={`$${total.toLocaleString()}`} subtitle="â†— +34% vs last period" accent="#00FF88" />
            <Card title="Monthly Recurring Revenue" value={`$${Math.round(mrr).toLocaleString()}`} subtitle="â†— Trending up" accent="#00FF88" />
            <Card title="Annual Recurring Revenue" value={`$${Math.round(arr).toLocaleString()}`} subtitle="Projected growth" accent="#00D9FF" />
            <Card title="Growth Rate" value={`${(growth * 100).toFixed(1)}%`} subtitle="Month over month" accent="#00FF88" />
          </div>

          {Array.isArray(data.by_period) && data.by_period.length > 0 && (
            <div style={{ background: 'rgba(255,255,255,0.03)', border: '1px solid rgba(255,255,255,0.08)', borderRadius: '12px', padding: '24px', marginBottom: '32px' }}>
              <h3 style={{ marginBottom: '20px', fontSize: '20px' }}>Revenue Trend</h3>
              <ResponsiveContainer width="100%" height={300}>
                <AreaChart data={data.by_period}>
                  <defs>
                    <linearGradient id="colorRevenue" x1="0" y1="0" x2="0" y2="1">
                      <stop offset="5%" stopColor="#0047FF" stopOpacity={0.3}/>
                      <stop offset="95%" stopColor="#0047FF" stopOpacity={0}/>
                    </linearGradient>
                  </defs>
                  <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.05)" />
                  <XAxis dataKey="period_start" stroke="#8B92A8" />
                  <YAxis stroke="#8B92A8" />
                  <Tooltip contentStyle={{ background: 'rgba(10, 14, 26, 0.95)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '8px' }} />
                  <Area type="monotone" dataKey="revenue" stroke="#0047FF" fill="url(#colorRevenue)" />
                </AreaChart>
              </ResponsiveContainer>
            </div>
          )}

          {Array.isArray(data.by_source) && data.by_source.length > 0 && (
            <div style={{ background: 'rgba(255,255,255,0.03)', border: '1px solid rgba(255,255,255,0.08)', borderRadius: '12px', padding: '24px' }}>
              <h3 style={{ marginBottom: '20px', fontSize: '20px' }}>Revenue by Source</h3>
              <ResponsiveContainer width="100%" height={300}>
                <PieChart>
                  <Pie
                    data={data.by_source}
                    cx="50%"
                    cy="50%"
                    labelLine={false}
                    label={(p) => `${p.source}: ${p.percentage || ''}%`}
                    outerRadius={100}
                    dataKey="revenue"
                  >
                    {data.by_source.map((entry, index) => (
                      <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                    ))}
                  </Pie>
                  <Tooltip contentStyle={{ background: 'rgba(10, 14, 26, 0.95)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '8px' }} />
                </PieChart>
              </ResponsiveContainer>
            </div>
          )}
        </div>
      );
    }

    function InsightsView({ insights }) {
      return (
        <div>
          <h2 style={{ fontSize: '24px', marginBottom: '24px' }}>AI-Powered Insights</h2>
          {(!insights || insights.length === 0) ? (
            <div style={{ textAlign: 'center', padding: '60px', color: '#8B92A8' }}>No insights available yet. Check back soon!</div>
          ) : (
            <div style={{ display: 'grid', gap: '20px' }}>
              {insights.map(insight => (
                <div
                  key={insight.id}
                  style={{
                    background: 'rgba(255,255,255,0.03)',
                    border: `1px solid ${insight.type === 'opportunity' ? '#00D9FF' : insight.type === 'warning' ? '#FFB800' : '#00FF88'}`,
                    borderLeft: `4px solid ${insight.type === 'opportunity' ? '#00D9FF' : insight.type === 'warning' ? '#FFB800' : '#00FF88'}`,
                    borderRadius: '12px',
                    padding: '24px'
                  }}
                >
                  <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '12px' }}>
                    <div>
                      <span style={{
                        background: insight.type === 'opportunity' ? 'rgba(0,217,255,0.1)' : insight.type === 'warning' ? 'rgba(255,184,0,0.1)' : 'rgba(0,255,136,0.1)',
                        color: insight.type === 'opportunity' ? '#00D9FF' : insight.type === 'warning' ? '#FFB800' : '#00FF88',
                        padding: '4px 12px',
                        borderRadius: '20px',
                        fontSize: '12px',
                        fontWeight: 600,
                        textTransform: 'uppercase'
                      }}>
                        {insight.type}
                      </span>
                      <span style={{ marginLeft: '12px', color: '#8B92A8', fontSize: '12px' }}>
                        {insight.impact} IMPACT
                      </span>
                    </div>
                    <div style={{ textAlign: 'center', padding: '8px 16px', background: 'rgba(0,217,255,0.1)', borderRadius: '8px' }}>
                      <div style={{ fontSize: '20px', fontWeight: 700, color: '#00D9FF' }}>{insight.confidence}%</div>
                      <div style={{ fontSize: '10px', color: '#8B92A8' }}>CONFIDENCE</div>
                    </div>
                  </div>
                  <h4 style={{ fontSize: '18px', marginBottom: '8px' }}>{insight.title}</h4>
                  <p style={{ color: '#8B92A8', lineHeight: 1.6 }}>{insight.description}</p>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }

    function ClientsView({ clients }) {
      return (
        <div>
          <h2 style={{ fontSize: '24px', marginBottom: '24px' }}>Client Portfolio</h2>
          {(!clients || clients.length === 0) ? (
            <div style={{ textAlign: 'center', padding: '60px', color: '#8B92A8' }}>No clients yet.</div>
          ) : (
            <div style={{ display: 'grid', gap: '16px' }}>
              {clients.map(client => (
                <div
                  key={client.id}
                  style={{
                    background: 'rgba(255,255,255,0.03)',
                    border: '1px solid rgba(255,255,255,0.08)',
                    borderRadius: '12px',
                    padding: '24px'
                  }}
                >
                  <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '16px' }}>
                    <div>
                      <h4 style={{ fontSize: '18px', marginBottom: '4px' }}>{client.company_name || client.name || 'Client'}</h4>
                      <span style={{ color: '#8B92A8', fontSize: '14px' }}>{client.industry || '-'}</span>
                    </div>
                    <div style={{ textAlign: 'right' }}>
                      <div style={{ fontSize: '24px', fontWeight: 700, marginBottom: '4px' }}>
                        ${Number(client.mrr || client.monthlyRevenue || 0).toLocaleString()}
                      </div>
                      <div style={{ fontSize: '12px', color: '#8B92A8' }}>Monthly Recurring</div>
                    </div>
                  </div>

                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                    <div>
                      <div style={{ fontSize: '12px', color: '#8B92A8', marginBottom: '8px' }}>Status</div>
                      <span style={{
                        background: String(client.status).toLowerCase() === 'active' ? 'rgba(0,255,136,0.1)' : 'rgba(255,184,0,0.1)',
                        color: String(client.status).toLowerCase() === 'active' ? '#00FF88' : '#FFB800',
                        padding: '4px 12px',
                        borderRadius: '20px',
                        fontSize: '12px',
                        fontWeight: 600,
                        textTransform: 'uppercase'
                      }}>
                        {client.status || 'active'}
                      </span>
                    </div>
                    <div>
                      <div style={{ fontSize: '12px', color: '#8B92A8', marginBottom: '8px' }}>Health Score</div>
                      <div style={{ fontSize: '20px', fontWeight: 700, color: '#00FF88' }}>
                        {Number(client.health_score || client.healthScore || 85)}%
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }

    // ========= APP =========
    function App() {
      const [token, setToken] = useState(localStorage.getItem('token'));
      const [user, setUser] = useState(JSON.parse(localStorage.getItem('user') || 'null'));

      const handleLogin = (newToken, newUser) => {
        setToken(newToken);
        setUser(newUser);
        localStorage.setItem('token', newToken);
        localStorage.setItem('user', JSON.stringify(newUser));
      };

      const handleLogout = () => {
        setToken(null);
        setUser(null);
        localStorage.removeItem('token');
        localStorage.removeItem('user');
      };

      return (
        <ErrorBoundary>
          {!token ? (
            <LoginPage onLogin={handleLogin} />
          ) : (
            <Dashboard token={token} user={user} onLogout={handleLogout} />
          )}
        </ErrorBoundary>
      );
    }

    // ========= RENDER =========
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
