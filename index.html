<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Butler & Co Revenue Intelligence Platform</title>

  <!-- Favicon to prevent 404 -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3E%F0%9F%93%8A%3C/text%3E%3C/svg%3E" />

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- PropTypes MUST be before Recharts -->
  <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/recharts@2.5.0/umd/Recharts.min.js"></script>

  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
      background: radial-gradient(1200px 700px at 20% 10%, rgba(0, 217, 255, 0.18), transparent 60%),
                  radial-gradient(1200px 700px at 80% 0%, rgba(0, 71, 255, 0.18), transparent 60%),
                  linear-gradient(135deg, #0A0E1A 0%, #10172A 100%);
      color: #fff;
      min-height: 100vh;
    }
    a { color: inherit; }
    button, input, select { font-family: inherit; }
    button { cursor: pointer; }

    .loading {
      display: flex; align-items: center; justify-content: center;
      min-height: 100vh; flex-direction: column; gap: 18px;
    }
    .spinner {
      width: 58px; height: 58px;
      border: 4px solid rgba(0, 71, 255, 0.15);
      border-top: 4px solid #00D9FF;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);} }

    .shell { padding: 24px; min-height: 100vh; }
    .card {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      box-shadow: 0 12px 45px rgba(0,0,0,0.35);
    }
    .muted { color: #8B92A8; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .grow { flex: 1; }
    .btn {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04);
      color: #fff;
      font-weight: 600;
      font-size: 13px;
      transition: transform .08s ease, opacity .2s ease;
    }
    .btn:hover { transform: translateY(-1px); }
    .btn:disabled { opacity: .6; cursor: not-allowed; transform: none; }

    .btnPrimary {
      border: none;
      background: linear-gradient(135deg, #0047FF, #00D9FF);
    }
    .btnDanger {
      border: 1px solid rgba(255,51,102,0.35);
      background: rgba(255,51,102,0.12);
      color: #FFB2C4;
    }
    .pill {
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      font-size: 12px;
      font-weight: 800;
      letter-spacing: .2px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }
    .pillDemo { border-color: rgba(0,217,255,0.32); background: rgba(0,217,255,0.10); color: #7BEFFF; }
    .pillLive { border-color: rgba(0,255,136,0.28); background: rgba(0,255,136,0.10); color: #8DFFCA; }

    /* Intelligence pills */
    .pillRiskLow { border-color: rgba(0,255,136,0.28); background: rgba(0,255,136,0.10); color: #8DFFCA; }
    .pillRiskMed { border-color: rgba(255,184,0,0.30); background: rgba(255,184,0,0.10); color: #FFE6A6; }
    .pillRiskHigh { border-color: rgba(255,51,102,0.35); background: rgba(255,51,102,0.12); color: #FFB2C4; }

    .pillOppYes { border-color: rgba(0,217,255,0.32); background: rgba(0,217,255,0.10); color: #7BEFFF; }
    .pillOppMaybe { border-color: rgba(255,184,0,0.30); background: rgba(255,184,0,0.10); color: #FFE6A6; }
    .pillOppNo { border-color: rgba(255,255,255,0.14); background: rgba(255,255,255,0.04); color: #8B92A8; }

    .nav {
      border-bottom: 1px solid rgba(255,255,255,0.10);
      margin: 18px 0 22px;
      display: flex; gap: 10px;
    }
    .navBtn {
      padding: 12px 18px;
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      color: #8B92A8;
      font-size: 14px;
      font-weight: 800;
      text-transform: capitalize;
    }
    .navBtnActive {
      color: #00D9FF;
      border-bottom-color: #00D9FF;
    }

    .gridKpi {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
      margin-bottom: 22px;
    }
    .kpi {
      padding: 18px;
      border-radius: 14px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
    }
    .kpiLabel { font-size: 13px; color: #8B92A8; margin-bottom: 8px; }
    .kpiValue { font-size: 34px; font-weight: 900; letter-spacing: .2px; margin-bottom: 8px; }
    .kpiSub {
      font-size: 13px;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .good { color: #00FF88; }
    .info { color: #00D9FF; }
    .warn { color: #FFB800; }

    .twoCol {
      display: grid;
      grid-template-columns: 1.3fr 1fr;
      gap: 16px;
    }
    @media (max-width: 980px) {
      .twoCol { grid-template-columns: 1fr; }
    }
    .panel { padding: 18px; }
    .panelTitle { font-size: 18px; font-weight: 900; margin-bottom: 14px; }

    .toast {
      position: fixed;
      bottom: 18px; left: 50%;
      transform: translateX(-50%);
      background: rgba(10, 14, 26, 0.92);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 12px;
      padding: 12px 14px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.45);
      display: flex; gap: 10px; align-items: center;
      max-width: 92vw;
      z-index: 9999;
    }
    .toastDot { width: 10px; height: 10px; border-radius: 50%; background: #00D9FF; }
    .toastText { font-size: 13px; color: #D8DCEF; }

    .alert {
      margin: 12px 0 18px;
      padding: 12px 14px;
      border-radius: 12px;
      background: rgba(255,184,0,0.10);
      border: 1px solid rgba(255,184,0,0.25);
      color: #FFE6A6;
      font-size: 13px;
      line-height: 1.4;
    }

    /* Modal */
    .modalBackdrop {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.55);
      display: flex; align-items: center; justify-content: center;
      padding: 18px;
      z-index: 9998;
    }
    .modal {
      width: 560px; max-width: 100%;
      background: rgba(10, 14, 26, 0.98);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 16px;
      box-shadow: 0 24px 90px rgba(0,0,0,0.55);
      overflow: hidden;
    }
    .modalHeader {
      padding: 16px 18px;
      display: flex; align-items: center; justify-content: space-between;
      border-bottom: 1px solid rgba(255,255,255,0.10);
    }
    .modalTitle { font-size: 16px; font-weight: 900; }
    .modalBody { padding: 16px 18px; }
    .field { margin-bottom: 12px; }
    .label { font-size: 12px; color: #8B92A8; margin-bottom: 7px; font-weight: 800; }
    .input, .select {
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      color: #fff;
      font-size: 14px;
      outline: none;
    }
    .modalFooter {
      padding: 14px 18px;
      border-top: 1px solid rgba(255,255,255,0.10);
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .small { font-size: 12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;
    const {
      AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip,
      ResponsiveContainer, PieChart, Pie, Cell, Line
    } = Recharts;

    // =========================
    // CONFIG
    // =========================
    const API_BASE = "https://butler-platform-backend.onrender.com/api/v1";

    // =========================
    // HELPERS
    // =========================
    const fmtMoney = (n) => {
      const num = Number(n || 0);
      return num.toLocaleString(undefined, { maximumFractionDigits: 0 });
    };

    const clamp = (n, min, max) => Math.min(max, Math.max(min, n));

    function safeJsonParse(str, fallback) {
      try { return JSON.parse(str); } catch { return fallback; }
    }

    // Number animation hook (smooth KPI count-up)
    function useCountUp(target, durationMs = 650) {
      const [value, setValue] = useState(Number(target || 0));
      const startRef = useRef(null);
      const fromRef = useRef(Number(target || 0));
      const toRef = useRef(Number(target || 0));

      useEffect(() => {
        const to = Number(target || 0);
        const from = value;
        fromRef.current = from;
        toRef.current = to;
        startRef.current = null;

        let raf;
        const tick = (ts) => {
          if (!startRef.current) startRef.current = ts;
          const t = clamp((ts - startRef.current) / durationMs, 0, 1);
          const eased = 1 - Math.pow(1 - t, 3); // easeOutCubic
          const next = fromRef.current + (toRef.current - fromRef.current) * eased;
          setValue(next);
          if (t < 1) raf = requestAnimationFrame(tick);
        };
        raf = requestAnimationFrame(tick);
        return () => cancelAnimationFrame(raf);
        // eslint-disable-next-line
      }, [target]);

      return value;
    }

    // Normalize revenue payload from backend OR demo
    function normalizeRevenue(raw) {
      const r = raw || {};

      const total = r.total_revenue ?? r.totalRevenue ?? r.total ?? 0;
      const mrr = r.mrr ?? r.monthly_recurring_revenue ?? r.monthlyRecurringRevenue ?? 0;
      const arr = r.arr ?? r.annual_recurring_revenue ?? r.annualRecurringRevenue ?? 0;
      const growth = r.growth_rate ?? r.growthRate ?? 0.34;

      const byPeriod = Array.isArray(r.by_period) ? r.by_period :
                       Array.isArray(r.byPeriod) ? r.byPeriod : [];

      const trend = byPeriod.map((p, idx) => ({
        period_start: p.period_start ?? p.period ?? p.label ?? `P${idx+1}`,
        revenue: Number(p.revenue ?? p.value ?? 0)
      })).filter(x => Number.isFinite(x.revenue));

      const bySource = Array.isArray(r.by_source) ? r.by_source :
                       Array.isArray(r.bySource) ? r.bySource : [];

      const sources = bySource.map((s, idx) => ({
        source: s.source ?? s.name ?? s.channel ?? `Source ${idx+1}`,
        revenue: Number(s.revenue ?? s.value ?? 0),
        percentage: s.percentage ?? null
      })).filter(x => Number.isFinite(x.revenue));

      return {
        total_revenue: Number(total || 0),
        mrr: Number(mrr || 0),
        arr: Number(arr || 0),
        growth_rate: Number(growth || 0),
        by_period: trend,
        by_source: sources
      };
    }

    // Build demo revenue summary from demo entries (local)
    function buildSummaryFromEntries(entries) {
      const total = entries.reduce((sum, e) => sum + Number(e.amount || 0), 0);

      // treat recurring as monthly for demo
      const recurringMonthly = entries
        .filter(e => e.type === "recurring")
        .reduce((sum, e) => sum + Number(e.amount || 0), 0);

      const mrr = recurringMonthly;
      const arr = recurringMonthly * 12;

      // Trend: group last 6 months
      const now = new Date();
      const months = [];
      for (let i = 5; i >= 0; i--) {
        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
        months.push({
          key: `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`,
          label: d.toLocaleString(undefined, { month: "short" }),
          revenue: 0
        });
      }

      const sourcesMap = {};
      for (const e of entries) {
        const d = new Date(e.date);
        const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
        const m = months.find(x => x.key === key);
        if (m) m.revenue += Number(e.amount || 0);
        const src = e.source || "Unknown";
        sourcesMap[src] = (sourcesMap[src] || 0) + Number(e.amount || 0);
      }

      const by_period = months.map(m => ({ period_start: m.label, revenue: m.revenue }));
      const by_source = Object.entries(sourcesMap).map(([source, revenue]) => ({ source, revenue }));

      // demo growth: compare last month to prior
      const last = months[months.length-1]?.revenue || 0;
      const prev = months[months.length-2]?.revenue || 0;
      const growth_rate = prev > 0 ? (last - prev) / prev : 0.34;

      return normalizeRevenue({ total, mrr, arr, growth_rate, by_period, by_source });
    }

    // =========================
    // FORECAST (Polished)
    // =========================
    function buildForecastSeries(by_period, points = 3) {
      if (!Array.isArray(by_period) || by_period.length < 3) {
        return { chartData: (by_period || []).map(p => ({ ...p, actual: p.revenue, forecast: null, isForecast: false })), hasForecast: false };
      }

      const base = by_period.map(p => ({
        period_start: p.period_start,
        actual: Number(p.revenue || 0),
        forecast: null,
        isForecast: false
      }));

      const vals = base.map(x => x.actual);
      const last3 = vals.slice(-3);
      const deltas = [last3[1]-last3[0], last3[2]-last3[1]];
      const avgDelta = (deltas[0] + deltas[1]) / 2;

      let prev = vals[vals.length - 1];
      const forecastRows = [];
      for (let i = 1; i <= points; i++) {
        const next = Math.max(0, prev + avgDelta);
        prev = next;
        forecastRows.push({
          period_start: `F+${i}`,
          actual: null,
          forecast: Number(next),
          isForecast: true
        });
      }

      // connect last actual to first forecast by copying last actual into forecast start baseline
      // (so dashed line starts at last known point)
      const lastActual = base[base.length - 1];
      const bridge = {
        period_start: lastActual.period_start,
        actual: lastActual.actual,
        forecast: lastActual.actual,
        isForecast: true,
        _bridge: true
      };

      const chartData = [...base, bridge, ...forecastRows];
      return { chartData, hasForecast: true };
    }

    // =========================
    // CLIENT INTELLIGENCE (Option B)
    // =========================
    function scoreClientIntelligence(client) {
      const status = String(client?.status || "").toLowerCase();
      const isActive = status === "active";
      const health = Number(client?.health_score ?? client?.healthScore ?? 0);
      const mrr = Number(client?.mrr ?? client?.monthlyRevenue ?? 0);

      // Scale banding
      let band = "micro";
      if (mrr >= 25000) band = "enterprise";
      else if (mrr >= 10000) band = "growth";
      else if (mrr >= 5000) band = "starter";

      // ---- Churn Risk Score (0 = low risk, 100 = high risk)
      // Stronger, more "enterprise" weighting:
      // - health is primary signal
      // - inactive status spikes risk
      // - small MRR accounts more fragile
      // - enterprise clients churn less frequently (slightly lower base risk)
      let churn = 0;

      // health contribution
      if (health >= 92) churn += 8;
      else if (health >= 85) churn += 18;
      else if (health >= 75) churn += 35;
      else if (health >= 65) churn += 55;
      else churn += 72;

      // status contribution
      if (!isActive) churn += 25;

      // MRR fragility
      if (mrr < 3000) churn += 18;
      else if (mrr < 6000) churn += 10;
      else if (mrr < 10000) churn += 6;

      // band adjustment
      if (band === "enterprise") churn -= 6;
      if (band === "micro") churn += 6;

      churn = clamp(churn, 0, 100);

      let churnLevel = "LOW";
      if (churn >= 70) churnLevel = "HIGH";
      else if (churn >= 40) churnLevel = "MEDIUM";

      // confidence: higher when health is extreme or status inactive
      let churnConf = 72;
      if (health >= 90 || health <= 65) churnConf += 12;
      if (!isActive) churnConf += 10;
      if (band === "enterprise") churnConf += 4;
      churnConf = clamp(churnConf, 55, 95);

      // ---- Expansion Opportunity Score (0 = no, 100 = very strong)
      // Higher for strong health + active + not already huge ARR
      let opp = 0;

      if (!isActive) opp -= 15;

      if (health >= 92) opp += 55;
      else if (health >= 85) opp += 44;
      else if (health >= 75) opp += 30;
      else if (health >= 65) opp += 18;
      else opp += 8;

      // sweet spot for expansion: growth/starter (room to grow)
      if (band === "starter") opp += 18;
      if (band === "growth") opp += 22;
      if (band === "enterprise") opp += 10; // still can expand (cross-sell), but lower % gain

      // MRR ceiling: if already enterprise, keep opp modest
      if (mrr >= 40000) opp -= 10;

      opp = clamp(opp, 0, 100);

      let oppLevel = "NO";
      if (opp >= 70) oppLevel = "YES";
      else if (opp >= 45) oppLevel = "MAYBE";

      let oppConf = 70;
      if (health >= 90) oppConf += 10;
      if (band === "growth" || band === "starter") oppConf += 6;
      if (!isActive) oppConf -= 10;
      oppConf = clamp(oppConf, 50, 94);

      return {
        band,
        churn: { score: churn, level: churnLevel, confidence: churnConf },
        opportunity: { score: opp, level: oppLevel, confidence: oppConf }
      };
    }

    // =========================
    // API
    // =========================
    const api = {
      async login(email, password) {
        const res = await fetch(`${API_BASE}/auth/token`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password })
        });
        if (!res.ok) throw new Error("Login failed");
        return res.json();
      },

      async get(endpoint, token) {
        const res = await fetch(`${API_BASE}${endpoint}`, {
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          }
        });
        if (!res.ok) throw new Error(`GET ${endpoint} failed`);
        return res.json();
      },

      async post(endpoint, data, token) {
        const res = await fetch(`${API_BASE}${endpoint}`, {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify(data)
        });
        if (!res.ok) throw new Error(`POST ${endpoint} failed`);
        return res.json();
      }
    };

    // =========================
    // DEMO STORAGE
    // =========================
    const LS_MODE = "butler_mode"; // "demo" or "live"
    const LS_DEMO_ENTRIES = "butler_demo_revenue_entries";
    const LS_TOKEN = "token";
    const LS_USER = "user";

    function defaultDemoEntries() {
      const now = new Date();
      const mk = (offsetDays, amount, source, type="one_time") => {
        const d = new Date(now);
        d.setDate(d.getDate() - offsetDays);
        return {
          id: crypto?.randomUUID?.() || String(Math.random()),
          date: d.toISOString().slice(0,10),
          amount,
          source,
          type,
          note: ""
        };
      };
      return [
        mk(3,  42000, "SEO", "one_time"),
        mk(14, 18000, "Paid Ads", "one_time"),
        mk(24, 12500, "Referrals", "recurring"),
        mk(38, 9800,  "Paid Ads", "recurring"),
        mk(52, 21000, "Direct", "one_time"),
        mk(68, 15500, "SEO", "recurring"),
      ];
    }

    function loadDemoEntries() {
      const saved = localStorage.getItem(LS_DEMO_ENTRIES);
      const parsed = saved ? safeJsonParse(saved, null) : null;
      if (Array.isArray(parsed) && parsed.length) return parsed;
      const seed = defaultDemoEntries();
      localStorage.setItem(LS_DEMO_ENTRIES, JSON.stringify(seed));
      return seed;
    }

    function saveDemoEntries(entries) {
      localStorage.setItem(LS_DEMO_ENTRIES, JSON.stringify(entries));
    }

    // =========================
    // UI COMPONENTS
    // =========================
    function Toast({ text }) {
      if (!text) return null;
      return (
        <div className="toast">
          <div className="toastDot" />
          <div className="toastText">{text}</div>
        </div>
      );
    }

    function Modal({ open, title, children, onClose }) {
      if (!open) return null;
      return (
        <div className="modalBackdrop" onMouseDown={onClose}>
          <div className="modal" onMouseDown={(e)=>e.stopPropagation()}>
            <div className="modalHeader">
              <div className="modalTitle">{title}</div>
              <button className="btn" onClick={onClose}>Close</button>
            </div>
            {children}
          </div>
        </div>
      );
    }

    Modal.propTypes = {
      open: PropTypes.bool,
      title: PropTypes.string,
      children: PropTypes.node,
      onClose: PropTypes.func
    };

    // =========================
    // LOGIN
    // =========================
    function LoginPage({ onLogin }) {
      const [email, setEmail] = useState("demo@butlerco.com");
      const [password, setPassword] = useState("demo123");
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState("");

      const submit = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError("");
        try {
          const data = await api.login(email, password);
          onLogin(data.access_token, data.user || { email });
        } catch (err) {
          setError("Invalid credentials. Try demo@butlerco.com / demo123");
        } finally {
          setLoading(false);
        }
      };

      return (
        <div style={{ minHeight: "100vh", display: "flex", alignItems: "center", justifyContent: "center", padding: 20 }}>
          <div className="card" style={{ maxWidth: 420, width: "100%", padding: 36 }}>
            <div style={{ textAlign: "center", marginBottom: 24 }}>
              <div style={{
                width: 64, height: 64,
                background: "linear-gradient(135deg, #0047FF, #00D9FF)",
                borderRadius: 14,
                margin: "0 auto 14px",
                display: "flex", alignItems: "center", justifyContent: "center",
                fontSize: 30
              }}>ðŸ“Š</div>
              <div style={{ fontSize: 24, fontWeight: 900 }}>Butler & Co</div>
              <div className="muted" style={{ fontSize: 13, marginTop: 6 }}>Revenue Intelligence Platform</div>
            </div>

            {error && <div className="alert">{error}</div>}

            <form onSubmit={submit}>
              <div className="field">
                <div className="label">Email</div>
                <input
                  className="input"
                  type="email"
                  value={email}
                  onChange={(e)=>setEmail(e.target.value)}
                  autoComplete="email"
                  required
                />
              </div>

              <div className="field">
                <div className="label">Password</div>
                <input
                  className="input"
                  type="password"
                  value={password}
                  onChange={(e)=>setPassword(e.target.value)}
                  autoComplete="current-password"
                  required
                />
              </div>

              <button className="btn btnPrimary" style={{ width: "100%", padding: 14, fontSize: 15 }} disabled={loading}>
                {loading ? "Signing in..." : "Sign In"}
              </button>
            </form>

            <div style={{ marginTop: 16, padding: 14, borderRadius: 12, border: "1px solid rgba(0,217,255,0.22)", background: "rgba(0,217,255,0.06)" }}>
              <div style={{ color: "#7BEFFF", fontWeight: 900, fontSize: 12 }}>Demo Account</div>
              <div className="muted small" style={{ marginTop: 6, lineHeight: 1.4 }}>
                Email: demo@butlerco.com<br/>
                Password: demo123
              </div>
            </div>
          </div>
        </div>
      );
    }

    LoginPage.propTypes = { onLogin: PropTypes.func };

    // =========================
    // DASHBOARD
    // =========================
    function Dashboard({ token, user, onLogout }) {
      const [activeView, setActiveView] = useState("overview");
      const [loading, setLoading] = useState(true);
      const [mode, setMode] = useState(localStorage.getItem(LS_MODE) || "demo"); // demo|live
      const [toast, setToast] = useState("");
      const [errorBanner, setErrorBanner] = useState("");

      const [revenueSummary, setRevenueSummary] = useState(null);
      const [insights, setInsights] = useState([]);
      const [clients, setClients] = useState([]);

      const [demoEntries, setDemoEntries] = useState(loadDemoEntries());
      const [showAddRevenue, setShowAddRevenue] = useState(false);
      const [refreshing, setRefreshing] = useState(false);

      // Persist demo entries
      useEffect(() => { saveDemoEntries(demoEntries); }, [demoEntries]);

      // Toast auto-hide
      useEffect(() => {
        if (!toast) return;
        const t = setTimeout(() => setToast(""), 2400);
        return () => clearTimeout(t);
      }, [toast]);

      useEffect(() => {
        loadAll(true);
        // eslint-disable-next-line
      }, []);

      const apiLabel = `${API_BASE.replace("/api/v1","")}/api/v1`;

      async function loadAll(initial=false) {
        if (!initial) setRefreshing(true);
        setErrorBanner("");

        try {
          if (mode === "demo") {
            const summary = buildSummaryFromEntries(demoEntries);
            setRevenueSummary(summary);

            setInsights([
              { id: 1, type: "opportunity", impact: "HIGH", confidence: 92, title: "SEO is driving profitable growth", description: "SEO revenue share is strong. Increase content velocity + internal linking to expand compounding returns." },
              { id: 2, type: "warning", impact: "MEDIUM", confidence: 84, title: "Paid Ads efficiency drift detected", description: "Paid Ads entries show higher volatility. Review CAC and tighten targeting for stability." },
              { id: 3, type: "success", impact: "HIGH", confidence: 90, title: "Recurring revenue base is healthy", description: "Recurring entries are building predictable MRR. Add upsell bundles to lift ARR." }
            ]);

            setClients([
              { id: 1, company_name: "TechCorp Industries", industry: "IT Services", status: "active", mrr: 12500, health_score: 92 },
              { id: 2, company_name: "BluePeak Manufacturing", industry: "Manufacturing", status: "active", mrr: 9800, health_score: 78 },
              { id: 3, company_name: "Summit Staffing Group", industry: "Staffing", status: "active", mrr: 15500, health_score: 88 },
              { id: 4, company_name: "Pioneer Legal Advisors", industry: "Professional Services", status: "inactive", mrr: 4200, health_score: 62 }
            ]);

            setToast("Demo data loaded.");
          } else {
            const [rev, ins, cls] = await Promise.all([
              api.get("/revenue/summary", token),
              api.get("/insights/latest?limit=5", token).catch(()=>({ data: { insights: [] } })),
              api.get("/clients", token).catch(()=>({ data: [] }))
            ]);

            const normalized = normalizeRevenue(rev?.data || rev);
            setRevenueSummary(normalized);

            setInsights(ins?.data?.insights || []);
            setClients(Array.isArray(cls?.data) ? cls.data : []);
            setToast("Live data synced.");
          }
        } catch (e) {
          console.error(e);
          setErrorBanner("Could not load data. If you are in LIVE mode, your backend might be sleeping or the token may be expired. Try Refresh, or switch to Demo.");
        } finally {
          setLoading(false);
          setRefreshing(false);
        }
      }

      function toggleMode() {
        const next = mode === "demo" ? "live" : "demo";
        setMode(next);
        localStorage.setItem(LS_MODE, next);
        setToast(next === "demo" ? "Switched to Demo mode." : "Switched to Live mode.");
        setLoading(true);
        setTimeout(() => loadAll(true), 150);
      }

      async function addRevenueEntry(entry) {
        if (mode === "demo") {
          const next = [{ ...entry, id: crypto?.randomUUID?.() || String(Math.random()) }, ...demoEntries];
          setDemoEntries(next);
          setRevenueSummary(buildSummaryFromEntries(next));
          setToast("Revenue entry saved (Demo).");
          return;
        }

        const payload = {
          date: entry.date,
          amount: Number(entry.amount),
          source: entry.source,
          type: entry.type,
          note: entry.note || ""
        };

        try {
          await api.post("/revenue/entries", payload, token);
          setToast("Revenue entry created (Live).");
        } catch (e1) {
          try {
            await api.post("/revenue/entry", payload, token);
            setToast("Revenue entry created (Live).");
          } catch (e2) {
            console.error(e2);
            setErrorBanner("Live revenue entry POST failed. Your backend might use a different endpoint. Tell me your backend route for creating revenue entries and Iâ€™ll wire it perfectly.");
            return;
          }
        }

        loadAll();
      }

      if (loading) {
        return (
          <div className="loading">
            <div className="spinner"></div>
            <div style={{ fontWeight: 900 }}>Loading platform...</div>
            <div className="muted small mono">Connecting: {API_BASE}</div>
          </div>
        );
      }

      return (
        <div className="shell">
          <div className="row" style={{ marginBottom: 12 }}>
            <div className="grow">
              <div style={{ fontSize: 34, fontWeight: 950, letterSpacing: .2 }}>Revenue Intelligence Platform</div>
              <div className="muted" style={{ marginTop: 6 }}>
                Welcome back, <span style={{ color: "#D8DCEF", fontWeight: 900 }}>{user?.firstName || user?.email || "User"}</span>
              </div>
            </div>

            <div className="row">
              <div className={"pill " + (mode === "demo" ? "pillDemo" : "pillLive")}>
                {mode === "demo" ? "DEMO MODE" : "LIVE MODE"}
              </div>

              <button className="btn" onClick={() => loadAll()} disabled={refreshing}>
                {refreshing ? "Refreshing..." : "â†» Refresh"}
              </button>

              <button className="btn" onClick={toggleMode}>
                {mode === "demo" ? "Switch to Live" : "Switch to Demo"}
              </button>

              <button className="btn btnDanger" onClick={onLogout}>
                Sign Out
              </button>
            </div>
          </div>

          <div className="row" style={{ marginBottom: 10 }}>
            <div className="muted small">
              Tip: {mode === "demo" ? "Demo mode saves changes in your browser (localStorage)." : "Live mode pulls from your backend."}
            </div>
            <div className="grow"></div>
            <div className="muted small mono">API: {apiLabel}</div>
          </div>

          {errorBanner && <div className="alert">{errorBanner}</div>}

          <div className="nav">
            {["overview", "insights", "clients"].map(v => (
              <button
                key={v}
                className={"navBtn " + (activeView === v ? "navBtnActive" : "")}
                onClick={() => setActiveView(v)}
              >
                {v}
              </button>
            ))}
          </div>

          {activeView === "overview" && (
            <OverviewView
              data={revenueSummary}
              mode={mode}
              onAddRevenue={() => setShowAddRevenue(true)}
            />
          )}

          {activeView === "insights" && <InsightsView insights={insights} />}

          {activeView === "clients" && <ClientsView clients={clients} />}

          <AddRevenueModal
            open={showAddRevenue}
            onClose={() => setShowAddRevenue(false)}
            onSave={async (entry) => {
              await addRevenueEntry(entry);
              setShowAddRevenue(false);
            }}
          />

          <Toast text={toast} />
        </div>
      );
    }

    Dashboard.propTypes = {
      token: PropTypes.string,
      user: PropTypes.object,
      onLogout: PropTypes.func
    };

    // =========================
    // OVERVIEW VIEW (Forecast added)
    // =========================
    function OverviewView({ data, mode, onAddRevenue }) {
      const safe = data || normalizeRevenue({});
      const animatedTotal = useCountUp(safe.total_revenue, 700);
      const animatedMrr = useCountUp(safe.mrr, 700);
      const animatedArr = useCountUp(safe.arr, 700);
      const animatedGrowth = useCountUp((safe.growth_rate || 0) * 100, 700);

      const COLORS = ["#0047FF", "#00D9FF", "#00FF88", "#FFB800", "#FF3366"];

      const hasTrend = Array.isArray(safe.by_period) && safe.by_period.length > 0 && safe.by_period.some(p => p.revenue > 0);
      const hasSource = Array.isArray(safe.by_source) && safe.by_source.length > 0 && safe.by_source.some(s => s.revenue > 0);

      const { chartData, hasForecast } = useMemo(() => {
        if (!hasTrend) return { chartData: [], hasForecast: false };
        return buildForecastSeries(safe.by_period, 3);
      }, [hasTrend, safe.by_period]);

      return (
        <div>
          <div className="row" style={{ marginBottom: 14 }}>
            <button className="btn btnPrimary" onClick={onAddRevenue}>
              + Add Revenue Entry
            </button>
            <div className="muted small">
              {mode === "demo" ? "Add entries to see charts update instantly." : "Creates an entry in your backend (if endpoint exists)."}
            </div>
            {hasForecast && (
              <div className="pill pillDemo" title="Forecast extends the trend using the last 3 periods.">
                Forecast: Next 3 periods (dashed)
              </div>
            )}
          </div>

          <div className="gridKpi">
            <div className="kpi">
              <div className="kpiLabel">Total Revenue</div>
              <div className="kpiValue">${fmtMoney(animatedTotal)}</div>
              <div className="kpiSub good">â†— +{(safe.growth_rate * 100).toFixed(1)}% vs last period</div>
            </div>

            <div className="kpi">
              <div className="kpiLabel">Monthly Recurring Revenue</div>
              <div className="kpiValue">${fmtMoney(animatedMrr)}</div>
              <div className="kpiSub good">â†— Trending up</div>
            </div>

            <div className="kpi">
              <div className="kpiLabel">Annual Recurring Revenue</div>
              <div className="kpiValue">${fmtMoney(animatedArr)}</div>
              <div className="kpiSub info">Projected run-rate</div>
            </div>

            <div className="kpi">
              <div className="kpiLabel">Growth Rate</div>
              <div className="kpiValue">{animatedGrowth.toFixed(1)}%</div>
              <div className="kpiSub good">Month over month</div>
            </div>
          </div>

          <div className="twoCol">
            <div className="card panel">
              <div className="panelTitle">Revenue Trend</div>
              {!hasTrend ? (
                <div className="muted" style={{ padding: 18, border: "1px dashed rgba(255,255,255,0.14)", borderRadius: 12 }}>
                  No trend data yet.
                </div>
              ) : (
                <ResponsiveContainer width="100%" height={320}>
                  <AreaChart data={chartData}>
                    <defs>
                      <linearGradient id="revFill" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="5%" stopColor="#00D9FF" stopOpacity={0.28} />
                        <stop offset="95%" stopColor="#00D9FF" stopOpacity={0} />
                      </linearGradient>
                    </defs>
                    <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.06)" />
                    <XAxis dataKey="period_start" stroke="#8B92A8" />
                    <YAxis stroke="#8B92A8" />
                    <Tooltip
                      contentStyle={{
                        background: "rgba(10, 14, 26, 0.95)",
                        border: "1px solid rgba(255,255,255,0.12)",
                        borderRadius: 10
                      }}
                      formatter={(v, name, ctx) => {
                        const label = name === "actual" ? "Actual Revenue" : "Forecast Revenue";
                        return [`$${fmtMoney(v)}`, label];
                      }}
                    />

                    {/* Actual area */}
                    <Area
                      type="monotone"
                      dataKey="actual"
                      stroke="#00D9FF"
                      fill="url(#revFill)"
                      strokeWidth={2}
                      connectNulls={true}
                    />

                    {/* Forecast dashed line */}
                    {hasForecast && (
                      <Line
                        type="monotone"
                        dataKey="forecast"
                        stroke="#7BEFFF"
                        strokeWidth={2}
                        strokeDasharray="6 6"
                        dot={false}
                        connectNulls={true}
                      />
                    )}
                  </AreaChart>
                </ResponsiveContainer>
              )}
            </div>

            <div className="card panel">
              <div className="panelTitle">Revenue by Source</div>
              {!hasSource ? (
                <div className="muted" style={{ padding: 18, border: "1px dashed rgba(255,255,255,0.14)", borderRadius: 12 }}>
                  No source breakdown yet.
                </div>
              ) : (
                <ResponsiveContainer width="100%" height={320}>
                  <PieChart>
                    <Pie
                      data={safe.by_source}
                      cx="50%"
                      cy="50%"
                      outerRadius={110}
                      dataKey="revenue"
                      labelLine={false}
                      label={({ source, percent }) => `${source} ${(percent * 100).toFixed(0)}%`}
                    >
                      {safe.by_source.map((_, i) => (
                        <Cell key={i} fill={COLORS[i % COLORS.length]} />
                      ))}
                    </Pie>
                    <Tooltip
                      contentStyle={{
                        background: "rgba(10, 14, 26, 0.95)",
                        border: "1px solid rgba(255,255,255,0.12)",
                        borderRadius: 10
                      }}
                      formatter={(v, _, p)=>[`$${fmtMoney(v)}`, p?.payload?.source || "Source"]}
                    />
                  </PieChart>
                </ResponsiveContainer>
              )}
            </div>
          </div>
        </div>
      );
    }

    OverviewView.propTypes = {
      data: PropTypes.object,
      mode: PropTypes.string,
      onAddRevenue: PropTypes.func
    };

    // =========================
    // INSIGHTS VIEW
    // =========================
    function InsightsView({ insights }) {
      return (
        <div>
          <div style={{ fontSize: 24, fontWeight: 950, marginBottom: 16 }}>AI-Powered Insights</div>

          {!insights || insights.length === 0 ? (
            <div className="muted" style={{ padding: 28, textAlign: "center" }}>
              No insights available yet.
            </div>
          ) : (
            <div style={{ display: "grid", gap: 14 }}>
              {insights.map((ins) => {
                const type = ins.type || "success";
                const border =
                  type === "opportunity" ? "rgba(0,217,255,0.35)" :
                  type === "warning" ? "rgba(255,184,0,0.35)" :
                  "rgba(0,255,136,0.30)";

                const left =
                  type === "opportunity" ? "#00D9FF" :
                  type === "warning" ? "#FFB800" :
                  "#00FF88";

                return (
                  <div key={ins.id} className="card" style={{ padding: 18, borderColor: border, borderLeft: `4px solid ${left}` }}>
                    <div className="row" style={{ justifyContent: "space-between", marginBottom: 10 }}>
                      <div className="row">
                        <span className="pill" style={{
                          borderColor: border,
                          background: "rgba(255,255,255,0.02)",
                          color: left
                        }}>
                          {String(type).toUpperCase()}
                        </span>
                        <span className="muted small" style={{ fontWeight: 900 }}>
                          {ins.impact || "MEDIUM"} IMPACT
                        </span>
                      </div>

                      <div style={{
                        padding: "8px 12px",
                        borderRadius: 12,
                        background: "rgba(0,217,255,0.08)",
                        border: "1px solid rgba(0,217,255,0.18)",
                        textAlign: "center",
                        minWidth: 88
                      }}>
                        <div style={{ fontSize: 18, fontWeight: 950, color: "#00D9FF" }}>{ins.confidence || 80}%</div>
                        <div className="muted" style={{ fontSize: 10, fontWeight: 900 }}>CONFIDENCE</div>
                      </div>
                    </div>

                    <div style={{ fontSize: 16, fontWeight: 950, marginBottom: 6 }}>
                      {ins.title || "Insight"}
                    </div>
                    <div className="muted" style={{ lineHeight: 1.55 }}>
                      {ins.description || "No description."}
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      );
    }

    InsightsView.propTypes = { insights: PropTypes.array };

    // =========================
    // CLIENTS VIEW (Option B Intelligence)
    // =========================
    function ClientsView({ clients }) {
      return (
        <div>
          <div style={{ fontSize: 24, fontWeight: 950, marginBottom: 8 }}>Client Portfolio</div>
          <div className="muted small" style={{ marginBottom: 16 }}>
            Client Intelligence uses health + MRR + status + scale banding to produce churn risk and expansion signals.
          </div>

          {!clients || clients.length === 0 ? (
            <div className="muted" style={{ padding: 28, textAlign: "center" }}>
              No clients available yet.
            </div>
          ) : (
            <div style={{ display: "grid", gap: 12 }}>
              {clients.map((c) => {
                const status = (c.status || "").toLowerCase();
                const active = status === "active";

                const intel = scoreClientIntelligence(c);

                // risk pill class
                const riskClass =
                  intel.churn.level === "HIGH" ? "pillRiskHigh" :
                  intel.churn.level === "MEDIUM" ? "pillRiskMed" :
                  "pillRiskLow";

                // opp pill class
                const oppClass =
                  intel.opportunity.level === "YES" ? "pillOppYes" :
                  intel.opportunity.level === "MAYBE" ? "pillOppMaybe" :
                  "pillOppNo";

                return (
                  <div key={c.id} className="card" style={{ padding: 18 }}>
                    <div className="row" style={{ justifyContent: "space-between", marginBottom: 12 }}>
                      <div style={{ minWidth: 220 }}>
                        <div style={{ fontSize: 16, fontWeight: 950 }}>{c.company_name || c.name || "Client"}</div>
                        <div className="muted small" style={{ marginTop: 4 }}>
                          {c.industry || "â€”"} â€¢ <span className="mono">{intel.band.toUpperCase()}</span>
                        </div>
                      </div>

                      <div style={{ textAlign: "right" }}>
                        <div style={{ fontSize: 22, fontWeight: 950 }}>${fmtMoney(c.mrr || c.monthlyRevenue || 0)}</div>
                        <div className="muted small">Monthly Recurring</div>
                      </div>
                    </div>

                    <div className="row" style={{ justifyContent: "space-between" }}>
                      <span className={"pill " + (active ? "pillLive" : "pillDemo")} style={{ padding: "6px 12px" }}>
                        {active ? "ACTIVE" : (c.status || "INACTIVE")}
                      </span>

                      <div className="row" style={{ gap: 10 }}>
                        <div className="muted small" style={{ fontWeight: 900 }}>Health</div>
                        <div style={{ fontWeight: 950, color: "#00FF88" }}>{(c.health_score || c.healthScore || 85)}%</div>
                      </div>
                    </div>

                    {/* Intelligence Row */}
                    <div className="row" style={{ marginTop: 14, gap: 10 }}>
                      <span className={"pill " + riskClass} title={`Churn score: ${intel.churn.score}/100`}>
                        Churn Risk: {intel.churn.level} â€¢ {intel.churn.confidence}%
                      </span>

                      <span className={"pill " + oppClass} title={`Opportunity score: ${intel.opportunity.score}/100`}>
                        Expansion: {intel.opportunity.level} â€¢ {intel.opportunity.confidence}%
                      </span>

                      <span className="pill" style={{ borderColor: "rgba(0,217,255,0.18)", background: "rgba(0,217,255,0.06)", color: "#7BEFFF" }}>
                        AI Signal
                      </span>
                    </div>

                    {/* Explanation microtext */}
                    <div className="muted small" style={{ marginTop: 10, lineHeight: 1.45 }}>
                      {intel.churn.level === "HIGH" && "âš  Risk elevated. Recommended: executive check-in + deliver quick-win + tighten SLA."}
                      {intel.churn.level === "MEDIUM" && "ðŸŸ  Monitor. Recommended: clarify next milestone + surface ROI snapshot."}
                      {intel.churn.level === "LOW" && "ðŸŸ¢ Stable. Recommended: quarterly business review + roadmap for next 90 days."}
                      {" "}
                      {intel.opportunity.level === "YES" && "ðŸš€ Expansion likely: propose upsell bundle + performance upgrade."}
                      {intel.opportunity.level === "MAYBE" && "âœ¨ Potential: validate needs + offer pilot add-on."}
                      {intel.opportunity.level === "NO" && "â€” Focus on retention + satisfaction."}
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      );
    }

    ClientsView.propTypes = { clients: PropTypes.array };

    // =========================
    // ADD REVENUE MODAL
    // =========================
    function AddRevenueModal({ open, onClose, onSave }) {
      const today = new Date().toISOString().slice(0,10);

      const [date, setDate] = useState(today);
      const [amount, setAmount] = useState("");
      const [source, setSource] = useState("SEO");
      const [type, setType] = useState("one_time");
      const [note, setNote] = useState("");
      const [saving, setSaving] = useState(false);

      useEffect(() => {
        if (!open) return;
        setDate(today);
        setAmount("");
        setSource("SEO");
        setType("one_time");
        setNote("");
        setSaving(false);
        // eslint-disable-next-line
      }, [open]);

      async function submit() {
        const amt = Number(amount);
        if (!date || !Number.isFinite(amt) || amt <= 0) return;

        setSaving(true);
        await onSave({ date, amount: amt, source, type, note });
        setSaving(false);
      }

      return (
        <Modal open={open} title="Add Revenue Entry" onClose={onClose}>
          <div className="modalBody">
            <div className="field">
              <div className="label">Date</div>
              <input className="input" type="date" value={date} onChange={(e)=>setDate(e.target.value)} />
            </div>

            <div className="field">
              <div className="label">Amount</div>
              <input
                className="input"
                type="number"
                value={amount}
                onChange={(e)=>setAmount(e.target.value)}
                placeholder="e.g. 12500"
                min="0"
                inputMode="numeric"
              />
            </div>

            <div className="field">
              <div className="label">Source</div>
              <select className="select" value={source} onChange={(e)=>setSource(e.target.value)}>
                <option>SEO</option>
                <option>Paid Ads</option>
                <option>Direct</option>
                <option>Referrals</option>
                <option>Partnerships</option>
                <option>Other</option>
              </select>
            </div>

            <div className="field">
              <div className="label">Type</div>
              <select className="select" value={type} onChange={(e)=>setType(e.target.value)}>
                <option value="one_time">One-time</option>
                <option value="recurring">Recurring (Monthly)</option>
              </select>
            </div>

            <div className="field">
              <div className="label">Note (optional)</div>
              <input className="input" value={note} onChange={(e)=>setNote(e.target.value)} placeholder="e.g. New client retainer / upsell / renewal" />
            </div>
          </div>

          <div className="modalFooter">
            <button className="btn" onClick={onClose}>Cancel</button>
            <button className="btn btnPrimary" onClick={submit} disabled={saving || !amount || Number(amount) <= 0}>
              {saving ? "Saving..." : "Save Entry"}
            </button>
          </div>
        </Modal>
      );
    }

    AddRevenueModal.propTypes = {
      open: PropTypes.bool,
      onClose: PropTypes.func,
      onSave: PropTypes.func
    };

    // =========================
    // APP
    // =========================
    function App() {
      const [token, setToken] = useState(localStorage.getItem(LS_TOKEN));
      const [user, setUser] = useState(safeJsonParse(localStorage.getItem(LS_USER), null));

      function handleLogin(t, u) {
        setToken(t);
        setUser(u);
        localStorage.setItem(LS_TOKEN, t);
        localStorage.setItem(LS_USER, JSON.stringify(u));
      }

      function handleLogout() {
        setToken(null);
        setUser(null);
        localStorage.removeItem(LS_TOKEN);
        localStorage.removeItem(LS_USER);
      }

      if (!token) return <LoginPage onLogin={handleLogin} />;

      return <Dashboard token={token} user={user} onLogout={handleLogout} />;
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
